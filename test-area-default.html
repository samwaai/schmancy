<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Area Default Component</title>
    <script type="module">
        import './dist/index.js';

        // Create a simple test component
        class TestDefault extends HTMLElement {
            constructor() {
                super();
                this.attachShadow({ mode: 'open' });
            }

            connectedCallback() {
                console.log('TestDefault connected');
                this.shadowRoot.innerHTML = `
                    <div style="padding: 20px; background: #f0f0f0;">
                        <h2>Default Component</h2>
                        <p>This is the default component</p>
                        <p>Timestamp: ${new Date().toISOString()}</p>
                    </div>
                `;
            }
        }

        // Register the component
        customElements.define('test-default', TestDefault);

        // Wait for DOM and test
        window.addEventListener('DOMContentLoaded', () => {
            // Create area with default
            const area = document.createElement('schmancy-area');
            area.name = 'test-area';
            area.default = 'test-default';

            document.body.appendChild(area);

            // Monitor for infinite loops
            let renderCount = 0;
            const originalConnectedCallback = TestDefault.prototype.connectedCallback;
            TestDefault.prototype.connectedCallback = function() {
                renderCount++;
                console.log(`Render count: ${renderCount}`);
                if (renderCount > 5) {
                    console.error('INFINITE LOOP DETECTED! Component rendered more than 5 times');
                    document.body.innerHTML = '<h1 style="color: red;">INFINITE LOOP DETECTED!</h1>';
                } else {
                    originalConnectedCallback.call(this);
                }
            };

            // Test navigation after 2 seconds
            setTimeout(() => {
                console.log('Testing navigation to non-existent route...');
                // This should keep the default component
                window.history.pushState({}, '', '/nonexistent');
                window.dispatchEvent(new PopStateEvent('popstate'));
            }, 2000);

            // Check final state after 4 seconds
            setTimeout(() => {
                console.log(`Final render count: ${renderCount}`);
                if (renderCount === 1) {
                    console.log('✅ SUCCESS: No infinite loop detected! Default component rendered exactly once.');
                    document.body.insertAdjacentHTML('beforeend', '<h2 style="color: green;">✅ Test Passed!</h2>');
                } else if (renderCount <= 3) {
                    console.log('⚠️ WARNING: Component rendered multiple times but not infinitely.');
                    document.body.insertAdjacentHTML('beforeend', '<h2 style="color: orange;">⚠️ Test Passed with warnings</h2>');
                } else {
                    console.error('❌ FAILURE: Too many renders detected');
                    document.body.insertAdjacentHTML('beforeend', '<h2 style="color: red;">❌ Test Failed</h2>');
                }
            }, 4000);
        });
    </script>
</head>
<body>
    <h1>Testing Area Default Component</h1>
    <p>This test verifies that the default component doesn't cause infinite loops.</p>
</body>
</html>